name: CD - Deploy to Production

on:
  workflow_dispatch:
    inputs:
      environment:
        description: '–í—ã–±–µ—Ä–∏—Ç–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è –¥–µ–ø–ª–æ—è'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      services:
        description: '–ö–∞–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã –¥–µ–ø–ª–æ–∏—Ç—å? (all/auth/lobby/game/pack/frontend/monitoring)'
        required: true
        default: 'all'
        type: string
      skip_backup:
        description: '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –±—ç–∫–∞–ø –ë–î?'
        required: false
        type: boolean
        default: false
  push:
    branches: [ main ]  # –ê–≤—Ç–æ–¥–µ–ø–ª–æ–π –ø—Ä–∏ –ø—É—à–µ –≤ main

env:
  SSH_USER: ubuntu
  APP_SERVER_IP: ${{ secrets.APP_SERVER_IP }}
  DEPLOY_PATH: /opt/sigame

jobs:
  # ==========================================
  # 1. PRE-DEPLOYMENT CHECKS
  # ==========================================
  pre-deploy:
    name: üîç Pre-Deployment Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚úÖ Validate inputs
        run: |
          echo "=========================================="
          echo "  –ü–ê–†–ê–ú–ï–¢–†–´ –î–ï–ü–õ–û–Ø"
          echo "=========================================="
          echo "Environment: ${{ inputs.environment }}"
          echo "Services: ${{ inputs.services }}"
          echo "Skip Backup: ${{ inputs.skip_backup }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "=========================================="

      - name: üîê Check secrets
        run: |
          if [ -z "${{ secrets.APP_SERVER_IP }}" ]; then
            echo "‚ùå APP_SERVER_IP –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå SSH_PRIVATE_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
            exit 1
          fi
          echo "‚úÖ –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –Ω–∞ –º–µ—Å—Ç–µ"

  # ==========================================
  # 2. BACKUP DATABASE
  # ==========================================
  backup:
    name: üíæ Backup Database
    runs-on: ubuntu-latest
    needs: [pre-deploy]
    if: ${{ !inputs.skip_backup }}
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîë Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.APP_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: üíæ Create backup
        run: |
          ssh ${{ env.SSH_USER }}@${{ secrets.APP_SERVER_IP }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            
            # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–æ–≤
            mkdir -p backups
            
            BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
            BACKUP_DIR="backups/backup_${BACKUP_DATE}"
            mkdir -p "$BACKUP_DIR"
            
            echo "üóÑÔ∏è –ë—ç–∫–∞–ø PostgreSQL..."
            
            # Auth DB
            docker exec sigame-postgres-auth pg_dump -U sigame_auth -d sigame_auth > "$BACKUP_DIR/auth.sql" || true
            
            # Lobby DB
            docker exec sigame-postgres-lobby pg_dump -U sigame_lobby -d sigame_lobby > "$BACKUP_DIR/lobby.sql" || true
            
            # Game DB
            docker exec sigame-postgres-game pg_dump -U sigame_game -d sigame_game > "$BACKUP_DIR/game.sql" || true
            
            # Pack DB
            docker exec sigame-postgres-packs pg_dump -U sigame_packs -d sigame_packs > "$BACKUP_DIR/packs.sql" || true
            
            # Compress backup
            cd backups
            tar -czf "backup_${BACKUP_DATE}.tar.gz" "backup_${BACKUP_DATE}"
            rm -rf "backup_${BACKUP_DATE}"
            
            echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: backup_${BACKUP_DATE}.tar.gz"
            
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (—Ö—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7)
            ls -t backup_*.tar.gz | tail -n +8 | xargs -r rm
          ENDSSH

  # ==========================================
  # 3. BUILD & PUSH (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è Docker Registry)
  # ==========================================
  build:
    name: üèóÔ∏è Build Services
    runs-on: ubuntu-latest
    needs: [pre-deploy]
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ‚ÑπÔ∏è Build info
        run: |
          echo "–ë–∏–ª–¥ –±—É–¥–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –≤—Ä–µ–º–µ–Ω–∏"
          echo "–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker Registry, –¥–æ–±–∞–≤—å—Ç–µ push –∑–¥–µ—Å—å"

  # ==========================================
  # 4. DEPLOY TO SERVER
  # ==========================================
  deploy:
    name: üöÄ Deploy to ${{ inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    needs: [backup, build]
    if: always() && (needs.backup.result == 'success' || needs.backup.result == 'skipped')
    environment:
      name: ${{ inputs.environment || 'production' }}
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîë Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.APP_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: üì§ Copy .env.production
        run: |
          # –ö–æ–ø–∏—Ä—É–µ–º .env —Ñ–∞–π–ª –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
          if [ -f .env.production ]; then
            scp .env.production ${{ env.SSH_USER }}@${{ secrets.APP_SERVER_IP }}:${{ env.DEPLOY_PATH }}/.env.production
          fi

      - name: üöÄ Deploy services
        run: |
          ssh ${{ env.SSH_USER }}@${{ secrets.APP_SERVER_IP }} << 'ENDSSH'
            set -e
            cd ${{ env.DEPLOY_PATH }}
            
            # –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è push-—Ç—Ä–∏–≥–≥–µ—Ä–∞ (–∫–æ–≥–¥–∞ inputs –ø—É—Å—Ç—ã–µ)
            SERVICES="${{ inputs.services }}"
            if [ -z "$SERVICES" ]; then
              SERVICES="all"
            fi
            
            echo "=========================================="
            echo "  üöÄ –ù–ê–ß–ê–õ–û –î–ï–ü–õ–û–Ø"
            echo "=========================================="
            echo "Branch: ${{ github.ref_name }}"
            echo "Commit: ${{ github.sha }}"
            echo "Services: $SERVICES"
            echo ""
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git..."
            git fetch origin
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ stash (–µ—Å–ª–∏ –µ—Å—Ç—å)
            echo "üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
            git stash push -m "Auto-stash before deployment $(date +%Y%m%d_%H%M%S)" || true
            
            # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω—É–∂–Ω—É—é –≤–µ—Ç–∫—É
            echo "üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–µ—Ç–∫—É ${{ github.ref_name }}..."
            git checkout ${{ github.ref_name }} || git checkout -b ${{ github.ref_name }} origin/${{ github.ref_name }}
            
            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —É–¥–∞–ª–µ–Ω–Ω–æ–π –≤–µ—Ç–∫–æ–π (—Ç–æ–ª—å–∫–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã)
            echo "üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —É–¥–∞–ª–µ–Ω–Ω–æ–π –≤–µ—Ç–∫–æ–π..."
            git reset --hard origin/${{ github.ref_name }}
            
            # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            # git clean -fd --exclude='services/e2e-tests/' --exclude='infrastructure/' || true
            
            if [ "$SERVICES" = "all" ]; then
              echo "üîÑ –î–µ–ø–ª–æ–π –í–°–ï–• —Å–µ—Ä–≤–∏—Å–æ–≤..."
              
              # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
              echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π..."
              sudo docker compose -f docker-compose.app.yml --env-file .env.production down --remove-orphans || true
              
              # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å
              sudo docker rm -f sigame-auth-service sigame-lobby-service sigame-game-service sigame-pack-service sigame-frontend 2>/dev/null || true
              
              # –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É (–ë–î, Kafka, Prometheus, Grafana –∏ —Ç.–¥.)
              echo "üìä –ó–∞–ø—É—Å–∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (PostgreSQL, Redis, Kafka, Prometheus, Grafana, Loki, Tempo)..."
              sudo docker compose -f docker-compose.infra.yml --env-file .env.production up -d --remove-orphans
              
              echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (60 —Å–µ–∫)..."
              sleep 60
              
              # –ó–∞—Ç–µ–º –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
              echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
              sudo docker compose -f docker-compose.app.yml --env-file .env.production up -d --build --force-recreate
              
            else
              echo "üîÑ –î–µ–ø–ª–æ–π —Å–µ—Ä–≤–∏—Å–∞: $SERVICES..."
              
              # –ï—Å–ª–∏ –¥–µ–ø–ª–æ–∏–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
              if [ "$SERVICES" = "monitoring" ] || [ "$SERVICES" = "grafana" ]; then
                echo "üìä –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
                sudo docker compose -f docker-compose.infra.yml --env-file .env.production restart grafana prometheus loki tempo promtail
              else
                # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å
                sudo docker compose -f docker-compose.app.yml --env-file .env.production rm -f -s ${SERVICES}-service || true
                sudo docker compose -f docker-compose.app.yml --env-file .env.production rm -f -s $SERVICES || true
                
                # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è
                sudo docker rm -f sigame-${SERVICES}-service sigame-${SERVICES} 2>/dev/null || true
                
                # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
                sudo docker compose -f docker-compose.app.yml --env-file .env.production up -d --build --force-recreate ${SERVICES}-service || \
                sudo docker compose -f docker-compose.app.yml --env-file .env.production up -d --build --force-recreate $SERVICES
              fi
            fi
            
            echo ""
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (30 —Å–µ–∫)..."
            sleep 30
            
            echo ""
            echo "=========================================="
            echo "  üìä –°–¢–ê–¢–£–° –°–ï–†–í–ò–°–û–í"
            echo "=========================================="
            sudo docker ps --format "table {{.Names}}\t{{.Status}}" | grep -E "NAME|sigame"
            
            echo ""
            echo "=========================================="
            echo "  ‚úÖ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–Å–ù!"
            echo "=========================================="
          ENDSSH

      - name: üßπ Cleanup old images
        run: |
          ssh ${{ env.SSH_USER }}@${{ secrets.APP_SERVER_IP }} << 'ENDSSH'
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö Docker –æ–±—Ä–∞–∑–æ–≤..."
            docker system prune -f --volumes || true
            echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
          ENDSSH

  # ==========================================
  # 5. POST-DEPLOYMENT CHECKS
  # ==========================================
  health-check:
    name: üè• Health Check
    runs-on: ubuntu-latest
    needs: [deploy]
    
    steps:
      - name: üîç Check services health
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤..."
          
          # Unified Agent
          if sudo docker ps | grep -q "sigame-unified-agent"; then
            echo "‚úÖ Unified Agent –∑–∞–ø—É—â–µ–Ω"
          else
            echo "‚ö†Ô∏è Unified Agent –Ω–µ –∑–∞–ø—É—â–µ–Ω"
          fi
          
          # Prometheus
          if curl -f -s -o /dev/null -w "%{http_code}" http://${{ secrets.APP_SERVER_IP }}:9090/-/healthy | grep -q "200"; then
            echo "‚úÖ Prometheus –¥–æ—Å—Ç—É–ø–µ–Ω"
          else
            echo "‚ö†Ô∏è Prometheus –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          fi
          
          # Frontend
          if curl -f -s -o /dev/null -w "%{http_code}" http://${{ secrets.APP_SERVER_IP }}:3001 | grep -q "200\|301\|302"; then
            echo "‚úÖ Frontend –¥–æ—Å—Ç—É–ø–µ–Ω"
          else
            echo "‚ö†Ô∏è Frontend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          fi
          
          # Auth Service
          if curl -f -s -o /dev/null -w "%{http_code}" http://${{ secrets.APP_SERVER_IP }}:8081/health | grep -q "200"; then
            echo "‚úÖ Auth Service –¥–æ—Å—Ç—É–ø–µ–Ω"
          else
            echo "‚ö†Ô∏è Auth Service –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          fi
          
          # Lobby Service
          if curl -f -s -o /dev/null -w "%{http_code}" http://${{ secrets.APP_SERVER_IP }}:8082/actuator/health | grep -q "200"; then
            echo "‚úÖ Lobby Service –¥–æ—Å—Ç—É–ø–µ–Ω"
          else
            echo "‚ö†Ô∏è Lobby Service –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          fi
          
          # Game Service
          if curl -f -s -o /dev/null -w "%{http_code}" http://${{ secrets.APP_SERVER_IP }}:8083/health | grep -q "200"; then
            echo "‚úÖ Game Service –¥–æ—Å—Ç—É–ø–µ–Ω"
          else
            echo "‚ö†Ô∏è Game Service –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          fi
          
          # Pack Service  
          if curl -f -s -o /dev/null -w "%{http_code}" http://${{ secrets.APP_SERVER_IP }}:8084/health | grep -q "200"; then
            echo "‚úÖ Pack Service –¥–æ—Å—Ç—É–ø–µ–Ω"
          else
            echo "‚ö†Ô∏è Pack Service –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          fi
          
          echo ""
          echo "üéâ Health check –∑–∞–≤–µ—Ä—à—ë–Ω!"

  # ==========================================
  # 6. NOTIFICATION
  # ==========================================
  notify:
    name: üì¢ Notification
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: always()
    
    steps:
      - name: üìä Deploy Summary
        run: |
          echo "=========================================="
          echo "  üìä –ò–¢–û–ì–ò –î–ï–ü–õ–û–Ø"
          echo "=========================================="
          echo "Environment: ${{ inputs.environment }}"
          echo "Services: ${{ inputs.services }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Status: ${{ needs.deploy.result }}"
          echo ""
          echo "üîó URL: http://${{ secrets.APP_SERVER_IP }}"
          echo "=========================================="
