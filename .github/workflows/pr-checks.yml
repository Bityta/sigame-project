name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  # ==========================================
  # –ó–∞–ø—É—Å–∫–∞–µ–º CI pipeline
  # ==========================================
  ci:
    name: ‚úÖ Run CI Pipeline
    uses: ./.github/workflows/ci.yml

  # ==========================================
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ PR
  # ==========================================
  pr-size:
    name: üìè Check PR Size
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìä Calculate changes
        id: changes
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          ADDITIONS=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$1} END {print sum}')
          DELETIONS=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$2} END {print sum}')
          
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
          
          echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ PR:"
          echo "Files changed: $CHANGED_FILES"
          echo "Lines added: $ADDITIONS"
          echo "Lines deleted: $DELETIONS"

      - name: üè∑Ô∏è Label PR size
        uses: actions/github-script@v7
        with:
          script: |
            const additions = parseInt('${{ steps.changes.outputs.additions }}') || 0;
            const deletions = parseInt('${{ steps.changes.outputs.deletions }}') || 0;
            const totalChanges = additions + deletions;
            
            let sizeLabel = 'size/XS';
            if (totalChanges > 1000) sizeLabel = 'size/XXL';
            else if (totalChanges > 500) sizeLabel = 'size/XL';
            else if (totalChanges > 250) sizeLabel = 'size/L';
            else if (totalChanges > 100) sizeLabel = 'size/M';
            else if (totalChanges > 30) sizeLabel = 'size/S';
            
            // Remove old size labels
            const labels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            for (const label of labels.data) {
              if (label.name.startsWith('size/')) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label.name,
                }).catch(() => {});
              }
            }
            
            // Add new size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [sizeLabel],
            });

  # ==========================================
  # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
  # ==========================================
  pr-comment:
    name: üí¨ Comment Results
    runs-on: ubuntu-latest
    needs: [ci, pr-size]
    if: always()
    permissions:
      pull-requests: write
    
    steps:
      - name: üí¨ Post comment
        uses: actions/github-script@v7
        with:
          script: |
            const ciStatus = '${{ needs.ci.result }}';
            const statusEmoji = ciStatus === 'success' ? '‚úÖ' : '‚ùå';
            
            const comment = `## ${statusEmoji} PR Checks Results
            
            ### CI Pipeline: ${ciStatus === 'success' ? '‚úÖ Passed' : '‚ùå Failed'}
            
            ${ciStatus === 'success' ? 
              'üéâ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã! PR –≥–æ—Ç–æ–≤ –∫ review –∏ merge.' : 
              '‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –ø—Ä–æ—à–ª–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏.'}
            
            ---
            
            ### üöÄ –ì–æ—Ç–æ–≤—ã –∫ –¥–µ–ø–ª–æ—é?
            
            –ü–æ—Å–ª–µ –º–µ—Ä–¥–∂–∞ —ç—Ç–æ–≥–æ PR –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:
            1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ [Actions ‚Üí CD - Deploy to Production](../../actions/workflows/deploy.yml)
            2. –ù–∞–∂–º–∏—Ç–µ "Run workflow"
            3. –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–µ–ø–ª–æ—è
            4. –ù–∞–∂–º–∏—Ç–µ "Run workflow" –µ—â—ë —Ä–∞–∑
            
            ---
            <sub>ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç GitHub Actions</sub>
            `;
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(c => 
              c.user.type === 'Bot' && c.body.includes('PR Checks Results')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }

  # ==========================================
  # –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
  # ==========================================
  all-checks:
    name: ‚úÖ All Checks Complete
    runs-on: ubuntu-latest
    needs: [ci, pr-size, pr-comment]
    if: always()
    
    steps:
      - name: üéØ Final Status
        run: |
          if [ "${{ needs.ci.result }}" = "success" ]; then
            echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!"
            exit 0
          else
            echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –ø—Ä–æ—à–ª–∏"
            exit 1
          fi

